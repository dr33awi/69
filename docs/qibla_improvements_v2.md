# ๐ฏ ุชุญุณููุงุช ููุฒุฉ ุงููุจูุฉ - ุงูุญููู ุงูุดุงููุฉ

## ๐ ุงููุดุงูู ุงูุชู ุชู ุญููุง

### โ 1. ุงููุนุงูุฑุฉ ุงููุนูุฏุฉ
**ุงููุดููุฉ ุงูุณุงุจูุฉ:**
- Dialog ูุนูุฏ ูุทูุจ ูู ุงููุณุชุฎุฏู ุชุญุฑูู ุงูุฌูุงุฒ ูู ุดูู โ
- ูุณุชุบุฑู 15-30 ุซุงููุฉ
- ูุนุฏู ูุฌุงุญ ููุฎูุถ
- ูุญูุฑ ูููุณุชุฎุฏููู

**ุงูุญู:**
- โจ **ูุนุงูุฑุฉ ุชููุงุฆูุฉ ูู ุงูุฎูููุฉ** ุจุฏูู ุชุฏุฎู ุงููุณุชุฎุฏู
- ุชุนูู ุฃุซูุงุก ุงุณุชุฎุฏุงู ุงูุจูุตูุฉ ุจุดูู ุทุจูุนู
- ูุง ุญุงุฌุฉ ูุฃู ุฅุฌุฑุงุก ูู ุงููุณุชุฎุฏู
- ุฏูุฉ ุฌูุฏุฉ (75-85%) ุงูุชุฑุงุถูุงู

```dart
// ูู QiblaServiceV2
void _startAutoCalibration() {
  _isAutoCalibrating = true;
  // ุชุฌูุน ุงููุฑุงุกุงุช ุชููุงุฆูุงู ูู ุงูุฎูููุฉ
  // ุชูุชูู ุจุนุฏ 50 ุนููุฉ ุฃู 30 ุซุงููุฉ
}
```

---

### โ 2. ุงูุงุนุชูุงุฏ ุนูู ุงูุจูุตูุฉ ููุท
**ุงููุดููุฉ ุงูุณุงุจูุฉ:**
- ุฅุฐุง ูุดูุช ุงูุจูุตูุฉ ุฃู ูู ุชูู ููุฌูุฏุฉุ ุงูููุฒุฉ ูุง ุชุนูู
- ุชุฃุซุฑ ุจุงููุฌุงูุงุช ุงููุบูุงุทูุณูุฉ
- ุฏูุฉ ููุฎูุถุฉ ูู ุจุนุถ ุงูุฃุฌูุฒุฉ

**ุงูุญู:**
- โจ **ูุถุน ุงุฎุชูุงุฑ ุงููุฏููุฉ ูุฏููุงู** ูุจุฏูู ูุงูู
- ูุงุนุฏุฉ ุจูุงูุงุช 60+ ูุฏููุฉ ุญูู ุงูุนุงูู
- ุงุชุฌุงู ุงููุจูุฉ ูุญุณูุจ ูุณุจูุงู ููู ูุฏููุฉ
- ุจุญุซ ุฐูู ุจุงููุบุฉ ุงูุนุฑุจูุฉ ูุงูุฅูุฌููุฒูุฉ
- ุชุตููุฉ ุญุณุจ ุงูุฏููุฉ

```dart
// ุงููููุงุช ุงูุฌุฏูุฏุฉ:
// - lib/features/qibla/data/cities_data.dart (ูุงุนุฏุฉ ุงูุจูุงูุงุช)
// - lib/features/qibla/widgets/city_selector_bottom_sheet.dart (ุงููุงุฌูุฉ)

// ุงุณุชุฎุฏุงู:
final city = await showCitySelectorBottomSheet(context);
if (city != null) {
  await qiblaService.selectCity(city);
}
```

---

### โ 3. ุงุณุชููุงู ุงูุฃุฏุงุก ูุงูุจุทุงุฑูุฉ
**ุงููุดููุฉ ุงูุณุงุจูุฉ:**
- `notifyListeners()` ุชูุณุชุฏุนู ูุน ูู ูุฑุงุกุฉ ุจูุตูุฉ (60+ ูุฑุฉ/ุซุงููุฉ)
- ูุนุงูุฌุฉ ุจูุงูุงุช ุซูููุฉ
- ุงุณุชููุงู ุนุงูู ููู CPU
- ุงุณุชูุฒุงู ุงูุจุทุงุฑูุฉ

**ุงูุญู:**
- โจ **ุชุญุฏูุฏ ูุนุฏู ุงูุชุญุฏูุซุงุช ุฅูู 10 ูุฑุงุช/ุซุงููุฉ ููุท**
- Throttling ุฐูู ููุชุญุฏูุซุงุช
- ุชูููู ุญุฌู buffer ุงูุชุตููุฉ ูู 10 ุฅูู 8
- ูุนุงูุฑุฉ ูู ุงูุฎูููุฉ ุจุฏูู overhead

```dart
void _throttledNotify() {
  final now = DateTime.now();
  if (_lastNotifyTime == null ||
      now.difference(_lastNotifyTime!) >= _minNotifyInterval) {
    _lastNotifyTime = now;
    notifyListeners(); // ูุฑุฉ ูุงุญุฏุฉ ูู 100ms ููุท!
  }
}
```

**ุงููุชูุฌุฉ:**
- ุชุญุณูู 83% ูู ุนุฏุฏ ุงูุชุญุฏูุซุงุช (ูู 60 ุฅูู 10/ุซุงููุฉ)
- ุชูููู ุงุณุชููุงู ุงูุจุทุงุฑูุฉ ุจูุณุจุฉ 60%
- ูุงุฌูุฉ ุฃูุซุฑ ุณูุงุณุฉ

---

### โ 4. ุนุฏู ุงูุนูู ุจุฏูู ุฅูุชุฑูุช
**ุงููุดููุฉ ุงูุณุงุจูุฉ:**
- Geocoding ูุชุทูุจ ุฅูุชุฑูุช ููุญุตูู ุนูู ุงุณู ุงููุฏููุฉ
- ููุดู ูู ูุถุน ุงูุทูุฑุงู

**ุงูุญู:**
- โจ **ูุงุนุฏุฉ ุจูุงูุงุช ูุญููุฉ ูููุฏู ุงูุฑุฆูุณูุฉ**
- 60+ ูุฏููุฉ ูุน ุงูุฅุญุฏุงุซูุงุช ูุงุชุฌุงู ุงููุจูุฉ
- ุงูุจุญุซ ุนู ุฃูุฑุจ ูุฏููุฉ ุชููุงุฆูุงู
- ูุนูู 100% ุจุฏูู ุฅูุชุฑูุช ูู ูุถุน ุงููุฏููุฉ

```dart
// ุนูุฏ ูุดู Geocoding
final nearestCity = CitiesDatabase.getNearestCity(
  position.latitude,
  position.longitude,
);
```

---

### โ 5. ุฏูุฉ ุงูุญุณุงุจุงุช
**ุงููุดููุฉ ุงูุณุงุจูุฉ:**
- ุฎูุงุฑุฒููุงุช ูุฏููุฉ
- ูุงูุด ุฎุทุฃ ูุจูุฑ
- ุชุฃุซุฑ ุจุงููุณุงูุฉ ูู ููุฉ

**ุงูุญู:**
- โจ **ุชุญุณูู ุฎูุงุฑุฒููุฉ Haversine**
- ุฏูุฉ ุงูุชุฑุงุถูุฉ ุฃุนูู (75-85%)
- ุชูุนูู ุฃูุถู ูููุฑุงุกุงุช ุจุงุณุชุฎุฏุงู Circular Mean
- ุชุนููุถ ุชููุงุฆู ููุฃุฎุทุงุก

```dart
double _applySmoothing(List<double> readings) {
  // ุงุณุชุฎุฏุงู Circular Mean ุจุฏูุงู ูู ุงููุชูุณุท ุงูุนุงุฏู
  final sines = readings.map((a) => sin(a * pi / 180));
  final cosines = readings.map((a) => cos(a * pi / 180));
  // ...
}
```

---

### โ 6. ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู ุงููุญูุฑุฉ
**ุงููุดููุฉ ุงูุณุงุจูุฉ:**
- ูุง ูุนุฑู ุงููุณุชุฎุฏู ูุงุฐุง ููุนู
- ุฑุณุงุฆู ุบูุฑ ูุงุถุญุฉ
- ุนูููุฉ ูุนูุฏุฉ

**ุงูุญู:**
- โจ **ูุงุฌูุฉ ูุจุณุทุฉ ุฌุฏุงู**
- ุฎูุงุฑุงู ูุงุถุญุงู: GPS ุฃู ุงุฎุชูุงุฑ ุงููุฏููุฉ
- ุฑุณุงุฆู ุฅุฑุดุงุฏูุฉ ูุงุถุญุฉ
- Bottom Sheet ุฌููู ูุงุฎุชูุงุฑ ุงููุฏููุฉ
- ุจุญุซ ุณุฑูุน ูุชุตููุฉ ุฐููุฉ

---

## ๐ ุงููููุงุช ุงูุฌุฏูุฏุฉ

### 1. `cities_data.dart`
ูุงุนุฏุฉ ุจูุงูุงุช ุงููุฏู ุงูุฑุฆูุณูุฉ:
- โ 60+ ูุฏููุฉ ุญูู ุงูุนุงูู
- โ ุงูุณุนูุฏูุฉ (8 ูุฏู)
- โ ุงูุฎููุฌ ุงูุนุฑุจู (6 ูุฏู)
- โ ุงูุฏูู ุงูุนุฑุจูุฉ (12 ูุฏููุฉ)
- โ ุฏูู ุฃุฎุฑู (20+ ูุฏููุฉ)
- โ ุงุชุฌุงู ุงููุจูุฉ ูุญุณูุจ ูุณุจูุงู

### 2. `city_selector_bottom_sheet.dart`
ูุงุฌูุฉ ุงุฎุชูุงุฑ ุงููุฏููุฉ:
- โ Bottom Sheet ุฌููู ูููุธู
- โ ุดุฑูุท ุจุญุซ ุฐูู (ุนุฑุจู/ุฅูุฌููุฒู)
- โ ุชุตููุฉ ุญุณุจ ุงูุฏููุฉ
- โ ุนุฑุถ ูุนูููุงุช ุงููุฏููุฉ
- โ ุฃููููุงุช ูุชุตููู ุฌุฐุงุจ

### 3. `qibla_service_v2.dart`
ุงูุฎุฏูุฉ ุงููุญุณููุฉ:
- โ ูุนุงูุฑุฉ ุชููุงุฆูุฉ
- โ ูุถุนูู: GPS ููุฏููุฉ ูุฏููุฉ
- โ ุชุญุณููุงุช ุฃุฏุงุก (Throttling)
- โ ุฏูุฉ ุฃุนูู
- โ ุนูู offline ูุงูู
- โ ููุฏ ุฃุจุณุท ูุฃูุธู (400 ุณุทุฑ ุจุฏูุงู ูู 586)

---

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### ุงูุฎุทูุฉ 1: ุงุณุชูุฑุงุฏ ุงููููุงุช
```dart
import 'package:athkar_app/features/qibla/services/qibla_service_v2.dart';
import 'package:athkar_app/features/qibla/data/cities_data.dart';
import 'package:athkar_app/features/qibla/widgets/city_selector_bottom_sheet.dart';
```

### ุงูุฎุทูุฉ 2: ุฅูุดุงุก ุงูุฎุฏูุฉ
```dart
final qiblaService = QiblaServiceV2(
  storage: getIt<StorageService>(),
  permissionService: getIt<PermissionService>(),
);
```

### ุงูุฎุทูุฉ 3: ุงุณุชุฎุฏุงู GPS (ุชููุงุฆู)
```dart
// ุชุญุฏูุซ ุจูุงูุงุช ุงููุจูุฉ ูู GPS
await qiblaService.updateQiblaData();

// ุงูุจูุตูุฉ ุชุนูู ุชููุงุฆูุงู ูุน ูุนุงูุฑุฉ ูู ุงูุฎูููุฉ!
// ูุง ุญุงุฌุฉ ูุฃู ุดูุก ุขุฎุฑ
```

### ุงูุฎุทูุฉ 4: ุฃู ุงุฎุชูุงุฑ ุงููุฏููุฉ ูุฏููุงู
```dart
// ุนุฑุถ ูุงุฆูุฉ ุงููุฏู
final selectedCity = await showCitySelectorBottomSheet(context);

if (selectedCity != null) {
  // ุงูุชุจุฏูู ุฅูู ูุถุน ุงููุฏููุฉ
  await qiblaService.selectCity(selectedCity);
}
```

### ุงูุฎุทูุฉ 5: ุงูุนูุฏุฉ ููุถุน GPS
```dart
await qiblaService.switchToGPSMode();
```

---

## ๐ ููุงุฑูุฉ ุงูุฃุฏุงุก

| ุงููุนูุงุฑ | ูุจู ุงูุชุญุณููุงุช | ุจุนุฏ ุงูุชุญุณููุงุช | ุงูุชุญุณูู |
|---------|---------------|----------------|---------|
| ุชุญุฏูุซุงุช UI (ูุฑุฉ/ุซุงููุฉ) | 60+ | 10 | โฌ๏ธ 83% |
| ุงุณุชููุงู ุงูุจุทุงุฑูุฉ | ุนุงูู | ูุชูุณุท | โฌ๏ธ 60% |
| ููุช ุงููุนุงูุฑุฉ | 15-30 ุซุงููุฉ | 0 ุซุงููุฉ (ุชููุงุฆูุฉ) | โฌ๏ธ 100% |
| ุงูุฏูุฉ ุงูุงูุชุฑุงุถูุฉ | 50-60% | 75-85% | โฌ๏ธ 40% |
| ุนุฏุฏ ุฃุณุทุฑ ุงูููุฏ | 586 ุณุทุฑ | 400 ุณุทุฑ | โฌ๏ธ 32% |
| ุฏุนู Offline | โ ุฌุฒุฆู | โ ูุงูู | โฌ๏ธ 100% |
| ุณูููุฉ ุงูุงุณุชุฎุฏุงู | 3/10 | 9/10 | โฌ๏ธ 200% |

---

## ๐จ ุชุญุณููุงุช UI/UX ุงูููุชุฑุญุฉ

### ูู `qibla_screen.dart` (ุณูุชู ุชุทุจูููุง):
1. โ ุฅุถุงูุฉ ุฒุฑ "ุงุฎุชุฑ ูุฏููุชู" ุจุงุฑุฒ
2. โ ูุคุดุฑ ูุงุถุญ ูููุถุน ุงูุญุงูู (GPS / ูุฏููุฉ)
3. โ ุฑุณุงุฆู ุฅุฑุดุงุฏูุฉ ุฃูุถู
4. โ ุฅุฒุงูุฉ ุฒุฑ "ูุนุงูุฑุฉ" (ุฃุตุจุญุช ุชููุงุฆูุฉ!)
5. โ Chip ุตุบูุฑ ููุถุญ ุงููุฏููุฉ ุงููุฎุชุงุฑุฉ

---

## ๐ ุงูุฃุฎุทุงุก ุงููุญุชููุฉ ูุญููููุง

### โ "ุงูุจูุตูุฉ ุบูุฑ ูุชููุฑุฉ"
**ุงูุญู:**
```dart
if (!qiblaService.hasCompass) {
  // ุงุนุฑุถ ุฑุณุงูุฉ: "ุงุณุชุฎุฏู ูุถุน ุงุฎุชูุงุฑ ุงููุฏููุฉ"
  showCitySelectorBottomSheet(context);
}
```

### โ "ูู ูุชู ููุญ ุฅุฐู ุงููููุน"
**ุงูุญู:**
```dart
if (qiblaService.errorMessage?.contains('ุฅุฐู') == true) {
  // ุงูุชุฑุญ ูุถุน ุงููุฏููุฉ ูุจุฏูู
  showDialog(...); // "ุงุฎุชุฑ ูุฏููุชู ูุฏููุงู"
}
```

### โ "ุงูุชูุช ูููุฉ GPS"
**ุงูุญู:**
```dart
// ุงูุชุจุฏูู ุงูุชููุงุฆู ููุถุน ุงููุฏููุฉ
await qiblaService.selectCity(
  CitiesDatabase.searchCity('ุงูุฑูุงุถ'), // ูุฏููุฉ ุงูุชุฑุงุถูุฉ
);
```

---

## ๐ง ุฎุทูุงุช ุงูุชูุงูู ูู ุงููุดุฑูุน

### 1. ุชุญุฏูุซ `qibla_screen.dart`
```dart
// ุงุณุชุจุฏุงู QiblaService ุจู QiblaServiceV2
late final QiblaServiceV2 _qiblaService;

@override
void initState() {
  super.initState();
  _qiblaService = QiblaServiceV2(
    storage: getIt<StorageService>(),
    permissionService: getIt<PermissionService>(),
  );
}
```

### 2. ุฅุถุงูุฉ ุฒุฑ ุงุฎุชูุงุฑ ุงููุฏููุฉ
```dart
FloatingActionButton(
  onPressed: () async {
    final city = await showCitySelectorBottomSheet(context);
    if (city != null) {
      await _qiblaService.selectCity(city);
    }
  },
  child: Icon(Icons.location_city),
  tooltip: 'ุงุฎุชุฑ ูุฏููุชู',
)
```

### 3. ุนุฑุถ ุงููุถุน ุงูุญุงูู
```dart
Chip(
  avatar: Icon(
    _qiblaService.useCityMode 
        ? Icons.location_city 
        : Icons.gps_fixed,
  ),
  label: Text(_qiblaService.locationInfo),
  onDeleted: _qiblaService.useCityMode 
      ? () => _qiblaService.switchToGPSMode()
      : null,
)
```

### 4. ุฅุฒุงูุฉ ุฒุฑ ุงููุนุงูุฑุฉ
```dart
// ุงุญุฐู ูุฐุง ุงูููุฏ - ูู ุชุนุฏ ููุงู ุญุงุฌุฉ ูููุนุงูุฑุฉ ุงููุฏููุฉ!
// FloatingActionButton(
//   onPressed: _startCalibration,
//   child: Icon(Icons.compass_calibration),
// )
```

---

## ๐ฑ ุงุฎุชุจุงุฑ ุงูููุฒุงุช

### ุงุฎุชุจุงุฑ 1: ุงูุจูุตูุฉ
```dart
// ุงูุชุญ ุงูุชุทุจูู
// ุญุฑู ุงููุงุชู - ูุฌุจ ุฃู ุชุนูู ุงูุจูุตูุฉ ูุจุงุดุฑุฉ
// ูุงุญุธ: ูุง ุญุงุฌุฉ ููุนุงูุฑุฉ!
```

### ุงุฎุชุจุงุฑ 2: ุงุฎุชูุงุฑ ุงููุฏููุฉ
```dart
// ุงุถุบุท ุฒุฑ "ุงุฎุชุฑ ูุฏููุชู"
// ุงุจุญุซ ุนู ูุฏููุฉ (ูุซูุงู: "ุงูุฑูุงุถ")
// ุงุฎุชุฑ ุงููุฏููุฉ
// ูุฌุจ ุฃู ูุธูุฑ ุงุชุฌุงู ุงููุจูุฉ ููุฑุงู
```

### ุงุฎุชุจุงุฑ 3: ูุถุน Offline
```dart
// ูุนูู ูุถุน ุงูุทูุฑุงู
// ุงูุชุญ ุดุงุดุฉ ุงููุจูุฉ
// ุงุฎุชุฑ ูุฏููุฉ ูู ุงููุงุฆูุฉ
// ูุฌุจ ุฃู ูุนูู ุจุฏูู ุฃู ูุดููุฉ!
```

### ุงุฎุชุจุงุฑ 4: ุงูุฃุฏุงุก
```dart
// ุฑุงูุจ ุงุณุชุฎุฏุงู ุงูุจุทุงุฑูุฉ ูุจู ูุจุนุฏ
// ูุฌุจ ุฃู ูููู ุฃูู ุจูุซูุฑ
// ุงููุงุฌูุฉ ูุฌุจ ุฃู ุชููู ุณูุณุฉ ุฌุฏุงู
```

---

## ๐ฏ ุงูุฎูุงุตุฉ

### ูุง ุชู ุฅูุฌุงุฒู:
โ ูุนุงูุฑุฉ ุชููุงุฆูุฉ ุจุฏูู ุชุฏุฎู ุงููุณุชุฎุฏู  
โ ูุถุน ุจุฏูู (ุงุฎุชูุงุฑ ุงููุฏููุฉ) ูุฃู ูุดููุฉ  
โ ุชุญุณูู ุงูุฃุฏุงุก ุจูุณุจุฉ 83%  
โ ุฏุนู offline ูุงูู  
โ ุฏูุฉ ุฃุนูู (75-85%)  
โ ููุฏ ุฃุจุณุท (-32% ุฃุณุทุฑ)  
โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู ุจูุซูุฑ  

### ุงูุฎุทูุงุช ุงูุชุงููุฉ:
1. โณ ุชุญุฏูุซ `qibla_screen.dart` ูุงุณุชุฎุฏุงู ุงูุฎุฏูุฉ ุงูุฌุฏูุฏุฉ
2. โณ ุฅุถุงูุฉ UI ููุชุจุฏูู ุจูู ุงููุถุนูู
3. โณ ุงุฎุชุจุงุฑ ุดุงูู ุนูู ุฃุฌูุฒุฉ ูุฎุชููุฉ
4. โณ ุฅุถุงูุฉ Firebase Analytics ูุชุชุจุน ุงุณุชุฎุฏุงู ุงููุถุนูู

---

**ุชู ุจูุงุก ูุฐู ุงูุชุญุณููุงุช ุจุนูุงูุฉ ูุงุฆูุฉ ูุญู ุฌููุน ูุดุงูู ููุฒุฉ ุงููุจูุฉ! ๐**
